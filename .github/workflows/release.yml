name: Release - Multi-Platform Builds

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v2.0.0, v1.1.0)
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller==6.11.1
          pip install --index-url https://download.pytorch.org/whl/cpu torch==2.4.1+cpu torchaudio==2.4.1+cpu
          pip install -r requirements/requirements-build.txt

      - name: Build Windows Onedir (Fast CI Validation)
        run: python -m PyInstaller --clean --noconfirm usdxfixgap-onedir.spec

      - name: Verify Windows Onedir Executable (Fast)
        run: |
          echo "Testing onedir build (fast - no extraction overhead)..."
          echo "Listing onedir output contents for verification:"
          Get-ChildItem -Force dist | Select-Object Name, Length | Format-Table -AutoSize
          .\dist\usdxfixgap-portable\usdxfixgap.exe --version
          if ($LASTEXITCODE -ne 0) {
            echo "[x] Onedir version check failed!"
            exit 1
          }
          echo "[ok] Windows onedir executable verified"
        timeout-minutes: 2

      - name: Smoke Test - Verify CPU PyTorch Import (Bundled)
        run: |
          echo "Testing bundled CPU PyTorch import..."
          .\dist\usdxfixgap-portable\usdxfixgap.exe --version
          if ($LASTEXITCODE -ne 0) {
            echo "[x] CPU PyTorch import failed!"
            exit 1
          }
          echo "[ok] Bundled CPU PyTorch imports successfully"
        timeout-minutes: 2

      - name: Package Windows Portable (Onedir)
        run: |
          # Package the onedir build before building onefile
          Compress-Archive -Path dist\* -DestinationPath usdxfixgap-portable-windows.zip -Force

      - name: Build Windows Onefile (Release Artifact)
        run: python -m PyInstaller --clean --noconfirm usdxfixgap.spec

      - name: Verify Windows Onefile Executable (First Run - Extraction)
        run: |
          echo "Testing onefile build (first run includes extraction)..."
          .\dist\usdxfixgap.exe --version
          if ($LASTEXITCODE -ne 0) {
            echo "[x] Onefile version check failed!"
            exit 1
          }
          echo "[ok] Windows onefile executable verified"
        timeout-minutes: 5

      - name: Upload Windows Onefile Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-onefile
          path: dist/usdxfixgap.exe
          retention-days: 7

      - name: Upload Windows Portable Artifact (Onedir)
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: usdxfixgap-portable-windows.zip
          retention-days: 7

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsndfile1 \
            ffmpeg \
            portaudio19-dev \
            libegl1 \
            libgl1 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-shape0 \
            libglib2.0-0 \
            libdbus-1-3 \
            libfontconfig1 \
            libx11-xcb1 \
            libxcb-cursor0

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install --no-cache-dir pyinstaller==6.11.1

      - name: Install Python dependencies (CPU-only PyTorch)
        run: |
          python -m pip install --no-cache-dir \
            --extra-index-url https://download.pytorch.org/whl/cpu \
            -r requirements/requirements-build-linux.txt

      - name: Verify no CUDA dependencies installed
        run: |
          BAD=$(python -m pip freeze | grep -E '^(nvidia-|pytorch-triton|triton==)' || true)
          if [ -n "$BAD" ]; then
            echo "âŒ ERROR: Unexpected CUDA-related packages found:"
            echo "$BAD"
            exit 1
          fi
          echo "âœ… No CUDA dependencies found - build will be CPU-only"

      - name: Build Linux Portable (Onedir)
        run: |
          python -m PyInstaller --clean --noconfirm usdxfixgap-onedir.spec

      - name: Package Linux Portable
        run: |
          cd dist
          tar -czf ../usdxfixgap-portable-linux.tar.gz usdxfixgap-portable
          cd ..

      - name: Build Linux Onefile
        run: |
          python -m PyInstaller --clean --noconfirm usdxfixgap.spec

      - name: Verify Linux Executable
        run: |
          echo "Testing executable..."
          chmod +x dist/usdxfixgap
          dist/usdxfixgap --version || exit 1
          echo "[ok] Linux executable verified"

      - name: Upload Linux Onefile Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-onefile
          path: dist/usdxfixgap
          retention-days: 7

      - name: Upload Linux Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-portable
          path: usdxfixgap-portable-linux.tar.gz
          retention-days: 7

  build-macos-arm64:
    name: Build macOS Executable (Apple Silicon)
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install portaudio ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller==6.11.1
          pip install -r requirements/requirements-build-macos.txt

      - name: Make build script executable
        run: chmod +x run.sh

      - name: Build macOS Portable (Onedir)
        run: |
          pyinstaller --clean --noconfirm usdxfixgap-onedir.spec

      - name: Package macOS Portable (ARM64)
        run: |
          cd dist
          tar -czf ../usdxfixgap-portable-macos-arm64.tar.gz usdxfixgap-portable
          cd ..

      - name: Build macOS Onefile
        run: |
          pyinstaller --clean --noconfirm usdxfixgap.spec

      - name: Verify macOS Executable
        run: |
          echo "Testing executable..."
          chmod +x dist/usdxfixgap
          dist/usdxfixgap --version || exit 1
          echo "[ok] macOS ARM64 executable verified"

      - name: Upload macOS Onefile Artifact (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-onefile
          path: dist/usdxfixgap
          retention-days: 7

      - name: Upload macOS Portable Artifact (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-portable
          path: usdxfixgap-portable-macos-arm64.tar.gz
          retention-days: 7

  build-macos-x64:
    name: Build macOS Executable (Intel)
    runs-on: macos-15-intel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install portaudio ffmpeg llvm

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller==6.11.1
          # Set LLVM paths for llvmlite compilation on Intel Mac
          export LLVM_CONFIG=$(brew --prefix llvm)/bin/llvm-config
          export LLVM_DIR=$(brew --prefix llvm)/lib/cmake/llvm
          export CMAKE_PREFIX_PATH=$(brew --prefix llvm)
          pip install -r requirements/requirements-build-macos.txt

      - name: Make build script executable
        run: chmod +x run.sh

      - name: Build macOS Portable (Onedir)
        run: |
          pyinstaller --clean --noconfirm usdxfixgap-onedir.spec

      - name: Package macOS Portable (x64)
        run: |
          cd dist
          tar -czf ../usdxfixgap-portable-macos-x64.tar.gz usdxfixgap-portable
          cd ..

      - name: Build macOS Onefile
        run: |
          pyinstaller --clean --noconfirm usdxfixgap.spec

      - name: Verify macOS Executable
        run: |
          echo "Testing executable..."
          chmod +x dist/usdxfixgap
          dist/usdxfixgap --version || exit 1
          echo "[ok] macOS x64 executable verified"

      - name: Upload macOS Onefile Artifact (x64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-onefile
          path: dist/usdxfixgap
          retention-days: 7

      - name: Upload macOS Portable Artifact (x64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-portable
          path: usdxfixgap-portable-macos-x64.tar.gz
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos-arm64, build-macos-x64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: get_version
        run: |
          # Read VERSION file (for release notes lookup only)
          VERSION=$(cat VERSION | tr -d '[:space:]' | tr -d '\r\n' | sed 's/^[.]*//g')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Release notes from: ${VERSION}"

          # Use tag name for filenames and release title (includes -rc1, -beta, etc.)
          TAG_NAME="${GITHUB_REF_NAME}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "Release tag: ${TAG_NAME}"

          # Detect pre-release from tag name (rc, beta, alpha)
          if [[ "${TAG_NAME}" =~ -(rc|beta|alpha) ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "ðŸ”– Pre-release detected from tag: ${TAG_NAME}"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "ðŸ“¦ Regular release: ${TAG_NAME}"
          fi

      - name: Check if release notes exist
        id: check_notes
        run: |
          NOTES_FILE="docs/releases/${VERSION}.md"
          if [ -f "$NOTES_FILE" ]; then
            echo "NOTES_EXIST=true" >> $GITHUB_ENV
            echo "NOTES_FILE=${NOTES_FILE}" >> $GITHUB_ENV
            echo "âœ… Release notes found: ${NOTES_FILE}"
          else
            echo "NOTES_EXIST=false" >> $GITHUB_ENV
            echo "âš ï¸  No release notes found at ${NOTES_FILE}"
            echo "Creating default release notes..."
          fi

      - name: Download Windows Onefile Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-onefile
          path: ./artifacts/windows-onefile

      - name: Download Windows Portable Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-portable
          path: ./artifacts/windows-portable

      - name: Download Linux Onefile Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-onefile
          path: ./artifacts/linux-onefile

      - name: Download Linux Portable Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-portable
          path: ./artifacts/linux-portable

      - name: Download macOS ARM64 Onefile Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-onefile
          path: ./artifacts/macos-arm64-onefile

      - name: Download macOS ARM64 Portable Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-portable
          path: ./artifacts/macos-arm64-portable

      - name: Download macOS x64 Onefile Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x64-onefile
          path: ./artifacts/macos-x64-onefile

      - name: Download macOS x64 Portable Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x64-portable
          path: ./artifacts/macos-x64-portable

      - name: Prepare release artifacts
        run: |
          mkdir -p release

          # Use TAG_NAME for filenames (includes -rc1, -beta, etc.)

          # Windows onefile
          cp artifacts/windows-onefile/usdxfixgap.exe release/usdxfixgap-${TAG_NAME}-windows.exe

          # Windows portable
          cp artifacts/windows-portable/usdxfixgap-portable-windows.zip release/usdxfixgap-${TAG_NAME}-windows-portable.zip

          # Linux onefile
          chmod +x artifacts/linux-onefile/usdxfixgap
          tar -czf release/usdxfixgap-${TAG_NAME}-linux.tar.gz -C artifacts/linux-onefile usdxfixgap

          # Linux portable
          cp artifacts/linux-portable/usdxfixgap-portable-linux.tar.gz release/usdxfixgap-${TAG_NAME}-linux-portable.tar.gz

          # macOS ARM64 (Apple Silicon) onefile
          chmod +x artifacts/macos-arm64-onefile/usdxfixgap
          tar -czf release/usdxfixgap-${TAG_NAME}-macos-arm64.tar.gz -C artifacts/macos-arm64-onefile usdxfixgap

          # macOS ARM64 portable
          cp artifacts/macos-arm64-portable/usdxfixgap-portable-macos-arm64.tar.gz release/usdxfixgap-${TAG_NAME}-macos-arm64-portable.tar.gz

          # macOS x64 (Intel) onefile
          chmod +x artifacts/macos-x64-onefile/usdxfixgap
          tar -czf release/usdxfixgap-${TAG_NAME}-macos-x64.tar.gz -C artifacts/macos-x64-onefile usdxfixgap

          # macOS x64 portable
          cp artifacts/macos-x64-portable/usdxfixgap-portable-macos-x64.tar.gz release/usdxfixgap-${TAG_NAME}-macos-x64-portable.tar.gz

          ls -lh release/

      - name: Generate release notes
        run: |
          if [ "$NOTES_EXIST" = "true" ]; then
            # Use existing release notes (VERSION for lookup, TAG_NAME for display)
            echo "Using release notes from: $NOTES_FILE"
            cat "$NOTES_FILE" > release_notes.md
          else
            # Generate default release notes with TAG_NAME
            echo "Generating default release notes for tag: $TAG_NAME"
            cat > release_notes.md << EOF
          # Release ${TAG_NAME}

          ## Downloads

          ### Windows
          - **One-File**: \`usdxfixgap-${TAG_NAME}-windows.exe\` (~450MB, ~10s first launch)
          - **Portable**: \`usdxfixgap-${TAG_NAME}-windows-portable.zip\` (instant startup)

          ### Linux
          - **One-File**: \`usdxfixgap-${TAG_NAME}-linux.tar.gz\` (~10s first launch)
          - **Portable**: \`usdxfixgap-${TAG_NAME}-linux-portable.tar.gz\` (instant startup)

          ### macOS (Apple Silicon - M1/M2/M3)
          - **One-File**: \`usdxfixgap-${TAG_NAME}-macos-arm64.tar.gz\` (~10s first launch)
          - **Portable**: \`usdxfixgap-${TAG_NAME}-macos-arm64-portable.tar.gz\` (instant startup)

          ### macOS (Intel)
          - **One-File**: \`usdxfixgap-${TAG_NAME}-macos-x64.tar.gz\` (~10s first launch)
          - **Portable**: \`usdxfixgap-${TAG_NAME}-macos-x64-portable.tar.gz\` (instant startup)

          ## Installation

          ### Windows (One-File)
          Download and run the \`.exe\` file. First launch extracts to temp (~10 seconds).

          ### Windows (Portable)
          1. Extract \`usdxfixgap-${TAG_NAME}-windows-portable.zip\`
          2. Run \`usdxfixgap.exe\` from the extracted folder
          3. Instant startup, no extraction delay

          ### Linux (One-File)
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-linux.tar.gz
          chmod +x usdxfixgap
          ./usdxfixgap
          \`\`\`

          ### Linux (Portable)
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-linux-portable.tar.gz
          cd usdxfixgap
          ./usdxfixgap
          \`\`\`

          ### macOS (One-File)

          **Apple Silicon (M1/M2/M3):**
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-macos-arm64.tar.gz
          chmod +x usdxfixgap
          ./usdxfixgap
          \`\`\`

          **Intel Mac:**
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-macos-x64.tar.gz
          chmod +x usdxfixgap
          ./usdxfixgap
          \`\`\`

          ### macOS (Portable)

          **Apple Silicon (M1/M2/M3):**
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-macos-arm64-portable.tar.gz
          cd usdxfixgap-portable
          ./usdxfixgap
          \`\`\`

          **Intel Mac:**
          \`\`\`bash
          tar -xzf usdxfixgap-${TAG_NAME}-macos-x64-portable.tar.gz
          cd usdxfixgap-portable
          ./usdxfixgap
          \`\`\`

          ### Which macOS version do I need?

          Run \`uname -m\` in Terminal:
          - \`arm64\` â†’ Download ARM64 version (Apple Silicon)
          - \`x86_64\` â†’ Download x64 version (Intel)

          ## Distribution Formats

          **One-File Executable**: Convenient single file, but extracts on every launch (~10s first time).
          **Portable Archive**: Extract once, instant startup forever. Recommended for power users.

          ## Notes

          This is an automated release. For detailed changelog, see the commit history.
          EOF
          fi

          echo "ðŸ“ Release Notes Preview:"
          head -n 20 release_notes.md

      - name: Create or Update Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if we're in a workflow_dispatch (manual trigger)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - create/update tag
            if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
              echo "Tag ${TAG_NAME} already exists, updating..."
              git tag -f -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
              git push -f origin "${TAG_NAME}"
            else
              echo "Creating new tag ${TAG_NAME}..."
              git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
              git push origin "${TAG_NAME}"
            fi
          else
            echo "Triggered by tag push: ${GITHUB_REF_NAME}"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          files: |
            release/usdxfixgap-${{ env.TAG_NAME }}-windows.exe
            release/usdxfixgap-${{ env.TAG_NAME }}-windows-portable.zip
            release/usdxfixgap-${{ env.TAG_NAME }}-linux.tar.gz
            release/usdxfixgap-${{ env.TAG_NAME }}-linux-portable.tar.gz
            release/usdxfixgap-${{ env.TAG_NAME }}-macos.tar.gz
            release/usdxfixgap-${{ env.TAG_NAME }}-macos-portable.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
