# v1.3.0 - VLC Backend Integration

## üéØ Highlights

**UI Freeze Fix**: Eliminated Windows Media Foundation deadlocks when clicking gap buttons in vocals mode by introducing VLC-based audio backend.

**Unified Media Architecture**: Complete abstraction layer with OS-specific adapters (VLC, Qt, AVFoundation, GStreamer) enables seamless playback across all platforms.

**User Experience**: No VLC installation required on Windows - app detects system VLC automatically and falls back to Qt/WMF with helpful dialog.

**Developer Experience**: VLC optional for development; `run.bat setup-vlc` downloads portable version if needed.

**Size**: Executables remain ~80MB (no VLC bundling).

## What's New

### VLC Audio Backend
- New: VLC-based audio backend for Windows (eliminates WMF freezes on gap button clicks)
- New: Unified media backend abstraction with OS-specific adapters (VLC/Qt/AVFoundation/GStreamer)
- New: VLC detection for system-installed VLC (automatic on Windows, fallback to Qt backends)
- New: Helpful dialog with VLC download link if not installed (Windows only)
- New: Developer VLC setup command (`run.bat setup-vlc` downloads VLC 3.0.21 portable for development)
- New: VLC instance configured for audio-only mode (no video subsystem, lower memory)

### Performance Optimizations
- New: Millisecond-precise seeking using VLC's `set_time()` (faster, more accurate than ratio-based positioning)
- New: Smart polling timers only run when media loaded (reduced CPU usage when idle)
- New: VLC quiet logging mode suppresses console spam (no ES_OUT_SET_PCR warnings)
- New: Adaptive position interpolation (auto-disables if backend provides ‚â•20 FPS, dynamically measures update frequency)
- New: Smart cursor snapping to nearest position (forward or backward, prevents always-backward jumps)
- New: Position display shows milliseconds (MM:SS:mmm format) for precise gap editing
- New: Position line visible and accurate when paused (continuous position polling)

### Project Structure
- New: Requirements files organized in `requirements/` subdirectory for cleaner project root
- New: VLC setup helper script (`scripts/setup_vlc_runtime.py`) automates portable VLC download

### Bug Fixes
- Fix: UI freezes eliminated when clicking gap buttons in vocals mode (VLC backend avoids WMF deadlocks)
- Fix: "Loading waveform..." placeholder now updates after waveform creation completes
- Fix: Startup dialog respects "Don't show again" checkbox (no longer forces GPU Pack prompt)
- Fix: VLC console spam suppressed (quiet logging mode enabled)
- Fix: 10 test failures resolved (Mock.filter attribute added to fixtures)
- Fix: USDB "Open in USDB" button works for all songs (metadata scanned during directory walk, no blocking pre-scan)
- Fix: Reload song preserves USDB ID from .usdb files (ReloadSongWorker scans directory for metadata)

## Technical Details

### Backend Architecture

**MediaBackend Protocol**:
- Abstract interface defining `load()`, `play()`, `pause()`, `stop()`, `seek()`, `set_volume()`, `get_position()`, `get_status()`
- Standardized `PlaybackState` and `MediaStatus` enums for cross-platform consistency

**OS-Specific Adapters**:
- **VlcBackendAdapter** (Windows): Polling-based (33ms position with interpolation, 200ms status), millisecond-precise seeking
- **QtBackendAdapter** (fallback): QMediaPlayer wrapper, reuses MediaPlayerLoader logic
- **BackendFactory**: Automatic OS detection, VLC runtime validation, graceful Qt fallback

**VLC Runtime Management**:
- **Development**: `run.bat setup-vlc` downloads VLC 3.0.21 portable (~100MB to `vlc_runtime/`)
- **Production**: PyInstaller bundles `vlc_runtime/` with release executables
- **Configuration**: `--quiet --no-xlib --no-video` flags for audio-only, silent operation

### PlayerController Refactoring

Complete rewrite to use backend abstraction:
- 24 methods updated to use `MediaBackend` interface
- Mode switching (Normal/Vocals) preserves playback state across backends
- Precise seeking with millisecond timestamps
- Cleanup enhanced with backend-specific unload logic

### Expert Optimizations

**Recommendation #3 (Precise Seeking)**:
- ‚úÖ Implemented: `player.set_time(position_ms)` instead of `set_position(ratio)`
- Result: Instant seek with no ratio calculation overhead

**Recommendation #5 (Reduced Polling)**:
- ‚úÖ Implemented: Status/position timers only active when media loaded
- Result: Near-zero CPU usage when player idle

**VLC Position Interpolation** (custom enhancement):
- Challenge: VLC's `get_time()` only updates 3-4x per second (300ms intervals)
- Solution: Adaptive position interpolation using `QElapsedTimer` to smooth between VLC updates
- Result: Smooth 30 FPS position updates (33ms polling) despite coarse VLC positions
- Implementation:
  - **Dynamic detection**: Measures actual VLC update frequency during playback (rolling 10-interval average)
  - **Auto-disable**: Interpolation turns off if VLC provides ‚â•20 FPS (unlikely but future-proof)
  - **Smart snapping**: Cursor jumps to **nearest** position (forward or backward), not always backward
  - **Adaptive capping**: Extrapolation capped at 1.5√ó measured average interval (typically ~450ms) to prevent drift

## Why VLC?

**Problem**: Windows Media Foundation (WMF) deadlocks when QtMultimedia tries to unload media while tracks are playing, causing UI freezes on gap button clicks.

**Solution**: VLC's libvlc provides:
- Non-blocking media lifecycle (load/unload without deadlocks)
- Cross-platform consistency (same API on Windows/Linux/macOS)
- Robust format support (handles all UltraStar audio formats)
- Lightweight footprint (audio-only mode, ~100MB runtime)

**Fallback Strategy**: If VLC unavailable, seamlessly falls back to Qt backends (QMediaPlayer with platform-native engines).

## Migration Notes

**No User Action Required**:
- VLC runtime bundled in release builds (automatic detection)
- Existing installations work unchanged (Qt backend fallback)
- Configuration preserved (no breaking changes)

**For Developers**:
- Run `run.bat setup-vlc` once to download VLC portable
- Requirements now in `requirements/` subdirectory
- Update import paths: `pip install -r requirements/requirements.txt`

## Testing

**631 tests passing**, including:
- VLC backend initialization and lifecycle
- Mode switching with backend fallback
- Position/status polling accuracy
- Cleanup and error handling
- Mock fixture compatibility

## FAQs

**Why does Windows use VLC but other platforms use Qt?**
Windows Media Foundation (WMF) has known deadlock issues with Qt's media pipeline. VLC avoids this entirely. macOS/Linux use native backends (AVFoundation/GStreamer) which don't have these issues.

**Will this increase the download size?**
No. VLC is not bundled - the app detects system-installed VLC automatically. Executables remain ~80MB.

**Can I use Qt backend on Windows?**
Yes, but not recommended. If VLC is not installed, the factory automatically falls back to Qt/WMF with a helpful dialog.

**What if VLC fails to load?**
The backend factory automatically falls back to Qt adapter. You'll see a helpful dialog with VLC download instructions.

## üôè Thanks

Special thanks to expert reviewers for optimization recommendations and testers who helped validate the freeze elimination!
