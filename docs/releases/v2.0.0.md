# v2.0.0 - Venv Migration, MDX-Only Detection, GPU Pack robustness

### ⚠️ Breaking Changes

- Migrated from Anaconda/Miniconda to standard Python venv (.venv) with wrapper scripts; first run will create environment automatically.
- Removed Spleeter and HQ Segment detection methods; MDX (Demucs) is the only detection provider.
- Storage location changed to platform-standard app data directories (from v1.1.0); existing configs in app dir are not deleted.
- Removed legacy DefaultOutputPath configuration and top-level 'output' directory concept.

### What's New

#### Detection & Performance
- MDX provider set as default with early-stop logic and model reuse for faster onset detection.
- Configurable vocal start window with iterative expansion for robust detection.
- Multi-entry gap info: folders with multiple .txt files now maintain independent gap detection data per song, preventing cross-contamination.

#### GPU Acceleration
- Optional GPU Pack with automatic hardware/version detection, auto-recovery, speed display, and cancellation support.
- Linux support for GPU Pack; dynamic PyTorch/torchaudio compatibility fixes.

#### UI & UX
- Viewport-based lazy loading for song table and instant task lane architecture to keep UI responsive.
- Log viewer improvements (horizontal scroll, better formatting) and window size/position persistence.
- **Watch Mode**: Real-time filesystem monitoring with automatic cache updates and gap detection scheduling.
  - OS-native watchers (Windows ReadDirectoryChangesW, macOS FSEvents, Linux inotify) for efficient monitoring
  - Automatic song discovery: new .txt files instantly scanned and added
  - Smart updates: modified .txt/.mp3/.wav files trigger targeted gap detection
  - Cache synchronization: deleted/moved songs automatically removed
  - Debouncing (500ms default) prevents processing storms during bulk operations
  - Targeted scanning: only changed songs processed, not entire directory
  - Configurable via `[WatchMode]` section: `watch_mode_default`, `watch_debounce_ms`, `watch_ignore_patterns`

#### Developer & Tests
- Tier-3 pipeline integration tests and expanded tier1/tier2 scenarios.
- Config save() refactored to minimal mutation (preserves unrelated settings) and integration-light GUI trigger tests.
- Major complexity reductions via strategy patterns and refactors; feature flags removed and unified code paths.

#### Bug Fixes
- Fixed status persistence after gap detection by updating song cache.
- Resolved multi-txt folder issue: each .txt file now stores gap info independently with automatic legacy format migration.
- Fixed runtime crashes and standardized worker error signal handling; improved QThread cleanup.
- Fixed MDX model warm-up and import issues; suppressed harmless MP3 warnings and made torchaudio import optional.
- Improved GPU Pack compatibility (wheel structure, version detection, metadata) and startup validation.
- Fixed infinite reload loop and locale number parsing; improved worker queue responsiveness and cancellation.
- Windows subprocess CREATE_NO_WINDOW issue corrected; normalization status update fixed.
- Automatic cache versioning: on first launch after upgrade, users are prompted to confirm a complete re-scan of all songs; cache is automatically cleared and rebuilds during normal operation.
- Fixed WinError 5 "Access Denied" during audio normalization by implementing multi-layer file lock prevention: extended retry logic with longer backoff (up to 3s), 800ms pre-worker delay, media player unload signaling, and QUEUED/PROCESSING status blocking to prevent media re-loads during background operations.
- Fixed config.ini values being reset during test runs by implementing lazy-loaded Config in AppData (prevents module-import-time creation) and automatic test mode detection using PYTEST_CURRENT_TEST environment variable to isolate test config to temporary directory.
- Fixed waveform amplitude normalization causing visual inconsistency by removing dynaudnorm filter from ffmpeg command; waveforms now preserve original audio amplitude for accurate visual comparison between normalized and original songs.
- Fixed song loading placeholder not displaying during initial directory load by setting is_loading_songs flag immediately when loading starts and connecting status visualizer to listChanged signal for real-time updates.
- **Waveform overlay markers**: Gap markers are now drawn dynamically as an overlay instead of being baked into PNG files. This allows real-time updates and clearer visual distinction. Markers are visible in both Original Audio and Vocal modes, with proper time positioning based on each waveform's duration. **Note:** Existing cached waveform files may contain old baked-in markers. To regenerate clean waveforms, either delete the PNG files in your output directory or use the "Create Waveforms" feature. New waveforms will be generated automatically as needed.
  - Red line: Current playback position (playhead) - used by "Save play position" button
  - Blue line: AI-detected gap - used by "Save detected gap" button
  - Gray dashed line: Original gap from file - shown for reference when using "Revert gap"

### Upgrading from v1.0.0

1. Pull latest code.
2. On Windows, run: .\run.bat install
3. On Linux/macOS, run: ./run.sh install
4. (Optional) Remove old conda env after successful migration.
5. Alternatively, download prebuilt binaries from the Releases page.

**Finding your data directory:**

- Windows: Press Win+R, type %LOCALAPPDATA%\USDXFixGap, press Enter
- Linux: ~/.local/share/USDXFixGap/
- macOS: ~/Library/Application Support/USDXFixGap/

### FAQs

**How do I enable GPU acceleration?**

Use .\run.bat install --gpu on Windows or ./run.sh install --gpu on Linux. The app auto-detects NVIDIA hardware and installs the correct wheels. Offline ZIP installation is supported.

**Do I need to migrate my settings?**

No action is required. The app creates a fresh config in the new data directory on first run. If you want to keep previous settings, copy config.ini (and optionally cache.db) from the old app directory to the new location.

### 🙏 Thanks

Thanks to all contributors and users for feedback, testing, and reports.
